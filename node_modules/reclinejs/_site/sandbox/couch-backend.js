  function formatDiskSize(bytes) {
    return (parseFloat(bytes)/1024/1024).toString().substr(0,4) + "MB"
  }
  
  function getDbInfo(url) {
    var dfd = $.Deferred();
    return couch.request({url: url}).then(function(dbInfo) {
      app.dbInfo = dbInfo;

      $.extend(app.dbInfo, {
        "host": window.location.host,
        "disk_size": formatDiskSize(app.dbInfo.disk_size)
      });

      if( util.inURL("_rewrite", app.baseURL) ) app.dbInfo.db_name = "api";
      
      dfd.resolve(dbInfo);
    });
    return dfd.promise();
  }

  function updateDocCount(totalDocs) {
    return couch.request({url: app.baseURL + 'api/_all_docs?' + $.param({startkey: '"_design/"', endkey: '"_design0"'})}).then(
      function ( data ) {
        var ddocCount = data.rows.length;
        $('#docCount').text(totalDocs - ddocCount + " documents");
      }
    )    
  }
    
  function bootstrap(id) {
    app.dbPath = app.baseURL + "api/";
    
    util.listenFor(['esc', 'return']);
    
    getDbInfo(app.dbPath).then(function( dbInfo ) {
      util.render('title', 'project-title', dbInfo);
      util.render( 'generating', 'project-actions' );    
            
      couch.session().then(function(session) {
        if ( session.userCtx.name ) {
          var text = "Sign out";
        } else {
          var text = "Sign in";
        }
        util.render('controls', 'project-controls', {text: text});
      })

      initializeTable();
    })
  }

  function fetchRows(id, skip) {

    var query = {
      "limit" : getPageSize()
    }
    
    if (id) {
      $.extend( query, {"startkey": '"' + id + '"'});
      if (id !== app.newest) $.extend( query, {"skip": 1});
    }
    
    if (skip) $.extend( query, {"skip": skip});
    
    var req = {url: app.baseURL + 'api/rows?' + $.param(query)};
    
    couch.request(req).then(function(response) {
      var offset = response.offset + 1;
      $('.viewpanel-pagingcount').text(offset + " - " + ((offset - 1) + getPageSize()));
      app.cache = response.rows.map(function(row) { return row.value; } );
      renderRows(response);
    });

  }
